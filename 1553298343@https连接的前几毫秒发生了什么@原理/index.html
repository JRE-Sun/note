
<!DOCTYPE html>
<html>
  <!-- OriginalSrc: https://www.yinchengli.com/2016/11/13/https/ -->
  <head>
    <meta http-equiv="Content-Type" content="text/html"; charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>https连接的前几毫秒发生了什么-原理</title>
    
<link rel="stylesheet" id="crayon-theme-github-css" href="assets/1553298343-c848e4dceee583902c595f0ee403d825.css" type="text/css" media="all">

<link rel="stylesheet" id="crayon-font-monaco-css" href="assets/1553298343-79ff5ecfe151e5a3b13d97083294fa02.css" type="text/css" media="all">

<link rel="stylesheet" id="oblique-bootstrap-css" href="assets/1553298343-db8f09d8b018f01e4709f666b14da85c.css" type="text/css" media="all">

<link rel="stylesheet" id="dashicons-css" href="assets/1553298343-a3eb9bf820aa67b522ec48baf4fd82c4.css" type="text/css" media="all">

<link rel="stylesheet" id="post-views-counter-frontend-css" href="assets/1553298343-0a5babd92650d67e5c8b58e0824a2295.css" type="text/css" media="all">

<link rel="stylesheet" id="oblique-body-fonts-css" href="assets/1553298343-3a5c2503741675dc7f6d0c06c2f5984c.css" type="text/css" media="all">

<link rel="stylesheet" id="oblique-style-css" href="assets/1553298343-f438fdae0e5b823704bb44d61915ce15.css" type="text/css" media="all">

<link rel="stylesheet" id="oblique-font-awesome-css" href="assets/1553298343-338aab44a7aefbe7d2328d34cb18229e.css" type="text/css" media="all">

<link rel="stylesheet" id="crayon-css" href="assets/1553298343-e3b41d74d29d004ec910b1fe27122f2c.css" type="text/css" media="all">
<style>

img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}

</style>
<style>

.site-branding { padding:150px 0; }
@media only screen and (max-width: 1024px) { .site-branding { padding:100px 0; } }
.site-logo { max-width:200px; }
.svg-block { fill:#1c1c1c;}
.footer-svg.svg-block { fill:#17191B!important;}
.site-footer { background-color:#17191B;}
body { color:#50545C}
.site-title a, .site-title a:hover { color:#f9f9f9}
.site-description { color:#dddddd}
.entry-title, .entry-title a { color:#000}
.entry-meta, .entry-meta a, .entry-footer, .entry-footer a { color:#9d9d9d}
.widget-area { background-color:#17191B}
.widget-area, .widget-area a { color:#f9f9f9}
.social-navigation li a { color:#ffffff}


</style>
<style>

html.cye-enabled.cye-nm:not(*:-webkit-full-screen) body,
 html.cye-enabled.cye-nm:not(*:-webkit-full-screen) #cye-workaround-body {-webkit-filter:contrast(91%) brightness(84%) invert(1);}
</style>
<style>
html.cye-enabled.cye-lm body{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>
html.cye-enabled.cye-lm div{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>
html.cye-enabled.cye-lm th{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}html.cye-enabled.cye-lm td{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>
html.cye-enabled.cye-lm input[type=text]{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}html.cye-enabled.cye-lm textarea{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>
html.cye-enabled.cye-lm select{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>
html.cye-enabled.cye-lm ul{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>
html.cye-enabled.cye-lm .cye-lm-tag,html.cye-enabled.cye-lm.cye-lm-tag{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}
</style>
<style>

</style>
<style>
.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}
</style>
<style>

					.site-header {
					    background: url("") no-repeat;
					    background-position: center top;
					    background-attachment: fixed;
					    background-size: cover;
					}
		
</style>
<style>
.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}
</style>
<style>
object,embed{                -webkit-animation-duration:.001s;-webkit-animation-name:playerInserted;                -ms-animation-duration:.001s;-ms-animation-name:playerInserted;                -o-animation-duration:.001s;-o-animation-name:playerInserted;                animation-duration:.001s;animation-name:playerInserted;}                @-webkit-keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}                @-ms-keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}                @-o-keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}                @keyframes playerInserted{from{opacity:0.99;}to{opacity:1;}}
</style>
<style>
#rwl-iqxin{position:fixed;transform:translate(-90px,0);width:85px;height:25px;font-size:12px;font-weight: 500;font-family:Verdana, Arial, '宋体';color:#fff;background:#333;z-index:2147483647;margin: 0;opacity:0.05;transition:0.3s;overflow:hidden;user-select:none;text-align:center;white-space:nowrap;line-height:25px;padding:0 16px;border:1px solid #ccc;border-width:1px 1px 1px 0;border-bottom-right-radius:5px;box-sizing: content-box;}#rwl-iqxin input{margin: 0;padding: 0;vertical-align:middle;-webkit-appearance:checkbox;-moz-appearance:checkbox;position: static;clip: auto;opacity: 1;cursor: pointer;}#rwl-iqxin.rwl-active-iqxin{left: 0px;transform:translate(0,0);opacity: 0.9;height: 32px;line-height: 32px}#rwl-iqxin label{margin:0;padding:0;font-weight:500;}#rwl-iqxin button{margin: 0;padding: 0 2px;border: none;border-radius: 2px;cursor: pointer;}#rwl-setMenu{text-align:left;font-size:14px;z-index:999999;border: 1px solid cornflowerblue;}#rwl-setMenu p{margin:5px auto;} 
</style>
<style>
#leftdiv,#rightdiv,#stickey_footer,#top_box,.ershiba,.recommend-box,.floatBottom img,.ad_float_left,body .img,.side-widget,.blog-post  .row .side,.content__tech{display:none!important;}<br>.box.pic_text img,#wp img,#postlist img{max-height: 400px;width: auto;}<br>.post-topheader__info--title{text-align: center;}<br>.blog-post  .row .main,.container.main-container .container,.main-area.article-area{width: 100%;max-width: 100%;}<br><br>#juejin .container{max-width:1140px;}<br><br>.container.main-container .sidebar,.container.main-container .article-suspended-panel,.global-component-box .suspension-panel{display:none!important;}
</style>

    <style class="mx-wc-style">
      .mx-wc-main img {max-width: 100%;}
      .mx-wc-main{
        box-sizing: content-box;
        background-color: rgb(28, 28, 28) !important;
        margin: 0 auto;
        max-width: 1100px;
        padding: 15px 15px 80px 15px;
      }

      .clipping-information{
        text-align: left;
        margin-top: 20px;
        background-color: #eeeeee !important;
        padding: 15px;
        border-radius: 4px;
        color: #333;
        font-size: 14px !important;
        line-height: 22px !important;
      }
      .clipping-information a {
        color: blue !important;
        text-decoration: underline !important;
      }
      .clipping-information label {
        display: inline;
        text-transform: none;
      }
      .clipping-information label > code {
        padding: 2px 8px;
        background-color: rgba(200, 200, 200, 0.7)!important;
        font-size: 14px;
      }

    </style>
  </head>
  <body style="background-color: #464646 !important; min-height: 100%; height: auto;" id="" class="post-template-default single single-post postid-288 single-format-standard">
    <div class="mx-wc-main">
      <DIV id="page" class="hfeed site" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><DIV id="content" class="site-content" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><DIV class="container content-wrapper" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><DIV id="primary" class="content-area" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><MAIN id="main" class="site-main" role="main" style="display: block; float: none; position: relative; top: 0; left: 0; border: 0px; width: 100%; min-width:100%; max-width: 100%; min-height: auto; max-height: 100%; height: auto; padding: 0px; margin: 0px;"><article id="post-288" class="post-288 post type-post status-publish format-standard hentry category-code mx-wc-selected-elem" style="float: none; position: relative; top: 0px; left: 0px; margin: 0px; flex: unset; width: 100%; max-width: 100%; box-sizing: border-box;">

	<header class="entry-header">
		<h1 class="entry-title">https连接的前几毫秒发生了什么</h1>
		<div class="entry-meta">
			<span class="posted-on"><a href="https://www.yinchengli.com/2016/11/13/https/" rel="bookmark"><time class="entry-date published" datetime="2016-11-13T17:33:49+00:00">2016年11月13日</time></a></span>		</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

			

	<div class="entry-content">
		<p>在讨论这个话题之前，先提几个问题：</p>
<ol>
<li>为什么说https是安全的，安全在哪里？</li>
<li>https是使用了证书保证它的安全的么？</li>
<li>为什么证书需要购买？</li>
</ol>
<p>我们先来看https要解决什么问题</p>
<h2>一、 https解决什么问题</h2>
<p>https要解决的问题就是中间人攻击，什么是中间人攻击（Man In The Middle Attack）呢？如下图所示：<br>
<img class="wp-image-871 aligncenter" src="assets/1553298343-b3db85021e7e0158a893c4863f04e291.jpg" alt="" width="334" height="163"></p>
<p>你和服务器的连接会经过一个中间人，你以为你和服务器在正常地传输入数据，其实这些数据都先经过了一个中间人，这个中间人可以窥探你的数据或者篡改你的数据后再发给服务器，相反也可以把服务器的数据修改了之后再发给你。而这个中间人对你是透明的，你不知道你的数据已经被人窃取或者修改了。</p>
<h2>二、 中间人攻击的方式</h2>
<p>常见的有以下两种：</p>
<h3>1）域名污染</h3>
<p>由于我们访问一个域名时需要先进行域名解析，即向DNS服务器请求某个域名的IP地址。例如taobao.com我这边解析的IP地址为：</p>
<p><img class="wp-image-906 aligncenter" src="assets/1553298343-7a7c14fd5c8bd748d108d49dae440077.png" alt="" width="354" height="137"></p>
<p>在经过DNS的中间链点可能会抢答，返回给你一个错误的IP地址，这个IP地址就指向中间人的机器。</p>
<h3>2）APR欺骗</h3>
<p>广域网的传输是用的IP地址，而在局域网里面是用的物理地址，例如路由器需要知道连接它的设备的物理地址它才可以把数据包发给你，它会通过一个ARP的广播，向所有设备查询某个IP地址的物理地址是多少，如下所示：<br>
<img class="wp-image-908 aligncenter" src="assets/1553298343-db2238d605a65590d7f7ca8f39a1f48b.png" alt="" width="762" height="50"></p>
<p>路由器发了一个广播，询问192.168.1.100的物理地址是多少，由于没有人响应，所以它每隔1秒就重新发了个包。由于这个网络上的所有机器都会收到这个包，所以这个时候就可以欺骗路由器：<br>
<img class="wp-image-909 aligncenter" src="assets/1553298343-f2345d68d638385edf4dc9a1b1fe64af.png" alt="" width="760" height="40"></p>
<p>上面的192.168.1.102就向路由器发了一个响应的包，告诉路由器它的物理地址。</p>
<h2>三、https是应对中间人攻击的唯一方式</h2>
<p>在ssl的源码里面就有一段注释：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5c957322eefb1513131070" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title">SSL_AuthCertificate function</span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><span class="crayon-language">C</span></div></div>
			
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;">/* cert is OK. This is the client side of an SSL connection.
 * Now check the name field in the cert against the desired hostname.
 * NB: This is our only defense against Man-In-The-Middle (MITM) attacks! 
 */</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c957322eefb1513131070-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c957322eefb1513131070-2">2</div><div class="crayon-num" data-line="crayon-5c957322eefb1513131070-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c957322eefb1513131070-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c957322eefb1513131070-1"><span class="crayon-c">/* cert is OK. This is the client side of an SSL connection.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c957322eefb1513131070-2"><span class="crayon-c"> * Now check the name field in the cert against the desired hostname.</span></div><div class="crayon-line" id="crayon-5c957322eefb1513131070-3"><span class="crayon-c"> * NB: This is our only defense against Man-In-The-Middle (MITM) attacks! </span></div><div class="crayon-line crayon-striped-line" id="crayon-5c957322eefb1513131070-4"><span class="crayon-c"> */</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>最后一句的意思就是说使用https，是应对中间人攻击的唯一方式。为什么这么说呢，这得从https连接的过程说起。</p>
<h2>四、https连接的过程</h2>
<p>如果对于一个外行人，可以这么解释：</p>
<p>https连接，服务器发送它的证书给浏览器（客户端），浏览器确认证书正确，并检查证书中对应的主机名是否正确，如果正确则双方加密数据后发给对方，对方再进行解密，保证数据是不透明的</p>
<p>但是如果这个外行人比较聪明，他可能会问你浏览器是怎么检验证书正确的，证书又是什么东西，加密后不会被中间人破解么?</p>
<p>首先证书是个什么东西，可以在浏览器上面看到证书的内容，例如我们访问谷歌，然后点击地址栏的小锁：<br>
<img class="wp-image-902 aligncenter" src="assets/1553298343-5ab7354af7b5061dd7c826ee4b88a999.png" alt="" width="331" height="18"></p>
<p>再点击详情-&gt;查看证书，就可以看到整个证书的完整内容：<br>
<img class="wp-image-910 aligncenter" src="assets/1553298343-563efb54138e52deec16a36bcff96bb1.jpg" alt="" width="380" height="150"></p>
<p>接下来再用一个WireShark的抓包工具，抓取整个https连接的包，并分析这些包的内容。</p>
<p>下面以访问淘宝为例，打开淘宝，可以在Chrome里面看到淘宝的IP<br>
<img class="wp-image-906 aligncenter" src="assets/1553298343-7a7c14fd5c8bd748d108d49dae440077.png" alt="" width="308" height="110"></p>
<p>然后打开WireShark，设定过滤条件为源IP和目的IP都为上面的IP，就可以观察到整一个连接建立的过程：<br>
<img class="wp-image-900 aligncenter" src="assets/1553298343-9e73b3fef0745c63dfe9c88620c8ebff.png" alt="" width="628" height="222"></p>
<p>第一步是肯定是要先建立TCP连接，这里就不说了，我们从Client Hello开始说起：</p>
<h3>1. Client Hello</h3>
<p>我们在wireshark里面观察，将client hello里面客户端发给服务器的一些重要信息罗列出来</p>
<p>（1）使用的TLS版本是1.2，TLS有三个版本，1.0，1.1，1.2，1.2是最新的版本，https的加密就是靠的TLS安全传输层协议：<br>
<img class="wp-image-911 aligncenter" src="assets/1553298343-4d8b797773ab21fcbe3c8b7b166b2a4d.png" alt="" width="423" height="78"></p>
<p>（2）客户端当前的时间和一个随机密码串，这个时间是距Unix元年(1970.1.1)的秒数，这里是147895117，随机数的作用下面再提及。<br>
<img class="wp-image-912 aligncenter" src="assets/1553298343-df6d9078d6321f7f1938aff4a1b408b6.png" alt="" width="606" height="53"></p>
<p>（3）sessionId，会话ID，第一次连接时为0，如果有sessionId，则可以恢复会话，而不用重复握手过程：</p>
<p><img class="wp-image-916 aligncenter" src="assets/1553298343-2cc1bb12a14dfb65f7c482fc5c6c1b2b.png" alt="" width="475" height="80"></p>
<p>（4）浏览器支持的加密组合方式：可以看到，浏览器一共支持22种加密组合方式，发给服务器，让服务器选一个。具体的加密方式下文再介绍<br>
<img class="wp-image-917 aligncenter" src="assets/1553298343-d79ea9e78956c644a5f59f067d6d53bf.png" alt="" width="456" height="437"></p>
<p>（5）还有一个比较有趣的东西是域名：</p>
<p><img class="wp-image-918 aligncenter" src="assets/1553298343-39e4ed7715cc31c6ef3e413ce0fb1541.png" alt="" width="310" height="127"></p>
<p>为什么说这个比较特别呢，因为域名是工作在应用层http里的，而握手是发生在TLS还在传输层。在传输层里面就把域名信息告诉服务器，好让服务根据域名发送相应的证书。</p>
<p>可以说，<code>https = http + tls</code>，如下图所示：</p>
<p><img class="wp-image-919 aligncenter" src="assets/1553298343-98736ce083fb5e43a709b42b1dcf668a.png" alt="" width="255" height="171"></p>
<p>数据传输还是用的http，加密用的tls。tls和ssl又是什么关系？ssl是tls的前身，ssl deprecated之后，才开始有了tls 1.0、1.1、1.2</p>
<h3>3. Server Hello</h3>
<p>服务器收到了Client Hello的信息后，就给浏览器发送了一个Server Hello的包，这个包里面有着跟Client Hello类似的消息：</p>
<p>（1）时间、随机数等，注意服务器还发送了一个Session Id给浏览器。</p>
<p><img class="wp-image-920 aligncenter" src="assets/1553298343-01ddf3095217b87320bf161fbd89141f.png" alt="" width="580" height="212"></p>
<p>（2）服务器选中的加密方式：服务器在客户端提供的方式里面选择了下面这种，这种加密方式也是目前很流行的一种方式：</p>
<p><img class="wp-image-921 aligncenter" src="assets/1553298343-9c4c96e10773cbb2dc835820dba6479c.png" alt="" width="549" height="23"></p>
<h3>4. Certificate证书</h3>
<p>接着服务器发送一个证书的包过来：</p>
<p><img class="wp-image-922 aligncenter" src="assets/1553298343-3988b28b9e085689d8f9c915f5e67e41.png" alt="" width="679" height="21"></p>
<p>在WireShark里面展开证书：</p>
<p><img class="wp-image-923 aligncenter" src="assets/1553298343-82710fd9904d33734f0fa8a0ef51da80.png" alt="" width="670" height="119"></p>
<p>服务器总共是发了三个证书，第一个叫做*.tmall.com，第二个证书叫做GlobalSign Org.，第三个叫GlobalSign Root.这三个证书是什么关系呢？这三个证书是相互依赖的关系，在浏览器里面可以看出：</p>
<p><img class="wp-image-879 aligncenter" src="assets/1553298343-eee05763d04b93012f74276189753617.png" alt="" width="553" height="117"></p>
<p>tmall的证书是依赖于GlobalSign Org的证书，换句话说，GlobalSign Org的证书为tmall的证书做担保，而根证书GlobalSign Root为GlobalSign Org做担保，形成一条依赖链。明白这点很重要，从技术的角度上来说，GlobalSign为tmall的证书做签名，只要签名验证正确就说明tmall的证书是合法的。</p>
<p>在tmall的证书里面会指明它的上一级证书是啥：</p>
<p><img class="wp-image-924 aligncenter" src="assets/1553298343-47c61fbc0afe98e25f0c434568cbddb1.png" alt="" width="698" height="195"></p>
<p>现在来看下一个证书里面具体有什么内容。</p>
<p>除了上面提到的<strong>签名</strong>外，每个证书还包含<strong>签名的算法</strong>，和<strong>被签名的证书</strong>tbsCertificate(to be signed Certificate)三部分：</p>
<p><img class="wp-image-872 aligncenter" src="assets/1553298343-8cabbfa9c64d5c62d6eda5ccab4a9fba.png" alt="" width="648" height="64"></p>
<p>这个tbsCertificate里面有什么东西呢？在WireShark里面展开可以看到，里面有申请证书时所填写的国家、省份、城市、组织名称：</p>
<p><img class="wp-image-874 aligncenter" src="assets/1553298343-cf3703ee93780e6ec20dd946ad917b27.png" alt="" width="572" height="331"></p>
<p>以及证书支持的域名，可以看到taobao就在里面：</p>
<p><img class="wp-image-889 aligncenter" src="assets/1553298343-cbce826f77a41973ccf32b42b76242d8.png" alt="" width="284" height="162"></p>
<p>证书的有效期，可以看到这个证书如果不续费到今年年底就要到期了：</p>
<p><img class="wp-image-925 aligncenter" src="assets/1553298343-af44d1d77bab9fb914edfa1ecd79ae76.png" alt="" width="302" height="101"></p>
<p>还有<strong>证书的公钥</strong>，GlobalSign Org的公钥为：</p>
<p><img class="wp-image-926 aligncenter" src="assets/1553298343-feafe7b034b795e4fc90f90897e6ad70.png" alt="" width="485" height="64"></p>
<p>我们把证书的公钥拷贝出来，它是一串270个字节的数字，16进制为540位：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5c957322eefbd285283476" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title">证书公钥</span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><span class="crayon-language">Java</span></div></div>
			
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;">String publicKey = "3082010a0282010100c70e6c3f23937fcc70a59d20c30e533f7ec04ec29849ca47d523ef03348574c8a3022e465c0b7dc9889d4f8bf0f89c6c8c5535dbbff2b3eafbe356e74a46d91322ca36d59bc1a8e3964393f20cbce6f9e6e899c86348787f5736691a191d5ad1d47dc29cd47fe18012ae7aea88ea57d8ca0a0a3a1249a262197a0d24f737ebb473927b05239b12b5ceeb29dfa41402b901a5d4a69c436488def87efee3f51ee5fedca3a8e46631d94c25e918b9895909aee99d1c6d370f4a1e352028e2afd4218b01c445ad6e2b63ab926b610a4d20ed73ba7ccefe16b5db9f80f0d68b6cd908794a4f7865da92bcbe35f9b3c4f927804eff9652e60220e10773e95d2bbdb2f10203010001";</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c957322eefbd285283476-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c957322eefbd285283476-1"><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">publicKey</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"3082010a0282010100c70e6c3f23937fcc70a59d20c30e533f7ec04ec29849ca47d523ef03348574c8a3022e465c0b7dc9889d4f8bf0f89c6c8c5535dbbff2b3eafbe356e74a46d91322ca36d59bc1a8e3964393f20cbce6f9e6e899c86348787f5736691a191d5ad1d47dc29cd47fe18012ae7aea88ea57d8ca0a0a3a1249a262197a0d24f737ebb473927b05239b12b5ceeb29dfa41402b901a5d4a69c436488def87efee3f51ee5fedca3a8e46631d94c25e918b9895909aee99d1c6d370f4a1e352028e2afd4218b01c445ad6e2b63ab926b610a4d20ed73ba7ccefe16b5db9f80f0d68b6cd908794a4f7865da92bcbe35f9b3c4f927804eff9652e60220e10773e95d2bbdb2f10203010001"</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>这个公钥是由什么组成的呢？这是由N和e组成的：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5c957322eefc1121808704" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div></div></div>
			
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;">publicKey = (N, e)</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c957322eefc1121808704-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c957322eefc1121808704-1"><span class="crayon-v">publicKey</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">N</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">e</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>其中N是一个大整数，由两个质数相乘得到：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5c957322eefc3126417704" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div></div></div>
			
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;">N = p * q</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c957322eefc3126417704-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c957322eefc3126417704-1"><span class="crayon-v">N</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e ">p *</span><span class="crayon-h"> </span><span class="crayon-v">q</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>e是一个幂指数。这个就涉及到非对称加密算法，它是针对对称加密算法来说的。什么是对称加密算法呢？所谓对称加密算法是说：会话双方使用相同的加密解密方式，所以会话前需要先传递加密方式或者说是密钥，而这个密钥很可能会被中间人截取。所以后来才有了非对称加密算法：加密和解密的方式不一样，加密用的密钥，而解密用的公钥，公钥是公开的，密钥是不会传播的，可能是保存在拥有视网膜扫描和荷枪实弹的警卫守护的机房当中。</p>
<p>第一个非对称加密算法叫Diffie-Hellman密钥交换算法，它是Diffie和Hellman发明的，后来1977年麻省理工的<strong>R</strong>ivest、<strong>S</strong>hamir 和 <strong>A</strong>dleman提出了一种新的非对称加密算法并以他们的名字命名叫RSA。它的优点就在于：</p>
<ol>
<li>加密和解密的计算非常简单</li>
<li>破解十分难，只要密钥的位数够大，以目前的计算能力是无法破解出密钥的</li>
</ol>
<p>可以说，只要有计算机网络的地方，就会有RSA。RSA加密具体是怎么进行的呢：</p>
<h3>5. RSA加密和解密</h3>
<p>假设发送的信息为Hello，由于Hello的ASCII编码为：104 101 108 108 111，所以要发送的信息为：</p>
<p style="text-align: center;">M = 1041010108108111</p>
<p>即先把要发送的文本转成ASCII编码或者是Unicode编码，然后进行加密：</p>
<p style="text-align: center;">EM = M^e % N</p>
<p>就是把M作e次幂，然后除以N取余数，得到EM，EM即为加密后的信息。其中（N，e）就是上文提到的公钥。接下来将EM发送给对方，对方收到后用自己的密钥进行解密：</p>
<p style="text-align: center;">M = EM^d % N</p>
<p style="text-align: left;">将加密的信息作d次幂，再除以N取模，（N，d）就是对方的密钥，这样就能够将EM还原为M，可以证明，只要密钥和公钥是一一配对的，上式一定成立。不知道密钥的人是无法破译的，上文已提到破解密钥是相当困难的。</p>
<p style="text-align: left;">接下来回到上文提到的证书的公钥，这是一串270个字节的数字，可以拆成两部分N和e：</p>
<p style="text-align: left;">&nbsp;<img class="wp-image-927 aligncenter" src="assets/1553298343-faa94a1f5669ef137f284e1dded5bf6a.jpg" alt="" width="395" height="255"></p>
<p style="text-align: left;">灰色的数字是用来作为标志的。N是一个16进制为512位、二进制为2048位的大数字。普通的证书是1024位，2048位是一个很高安全级别，换算成10进制是617位，如果你能够将这个617位的大整数拆成两个质数相乘，就可以推导出GlobalSign的密钥，也就是说你破解了GlobalSign的证书（但这是不可能的）。</p>
<p style="text-align: left;">e为65537，证书通常取的幂指数都为这个数字。</p>
<p style="text-align: left;">在证书里面知道证书使用的加密算法为RSA + SHA256，SHA是一种哈希算法，可用来检验证书是否被篡改过：</p>
<p style="text-align: left;"><img class="wp-image-928 aligncenter" src="assets/1553298343-4407236980050162e5c5b6ea7619a567.png" alt="" width="560" height="82"></p>
<p style="text-align: left;">我们将encrypted的值拷贝出来就是证书的签名：</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5c957322eefc7836076325" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title">tmall证书签名</span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><span class="crayon-language">Java</span></div></div>
			
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;">String sinature = "3ec0c71903a19be74dca101a01347ac1464c97e6e5be6d3c6677d599938a13b0db7faf2603660d4aec7056c53381b5d24c2bc0217eb78fb734874714025a0f99259c5b765c26cacff0b3c20adc9b57ea7ca63ae6a2c990837473f72c19b1d29ec575f7d7f34041a2eb744ded2dff4a2e2181979dc12f1e7511464d23d1a40b82a683df4a64d84599df0ac5999abb8946d36481cf3159b6f1e07155cf0e8125b17aba962f642e0817a896fd6c83e9e7a9aeaebfcc4adaae4df834cfeebbc95342a731f7252caa2a97796b148fd35a336476b6c23feef94d012dbfe310da3ea372043d1a396580efa7201f0f405401dff00ecd86e0dcd2f0d824b596175cb07b3d";</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c957322eefc7836076325-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c957322eefc7836076325-1"><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">sinature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"3ec0c71903a19be74dca101a01347ac1464c97e6e5be6d3c6677d599938a13b0db7faf2603660d4aec7056c53381b5d24c2bc0217eb78fb734874714025a0f99259c5b765c26cacff0b3c20adc9b57ea7ca63ae6a2c990837473f72c19b1d29ec575f7d7f34041a2eb744ded2dff4a2e2181979dc12f1e7511464d23d1a40b82a683df4a64d84599df0ac5999abb8946d36481cf3159b6f1e07155cf0e8125b17aba962f642e0817a896fd6c83e9e7a9aeaebfcc4adaae4df834cfeebbc95342a731f7252caa2a97796b148fd35a336476b6c23feef94d012dbfe310da3ea372043d1a396580efa7201f0f405401dff00ecd86e0dcd2f0d824b596175cb07b3d"</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>这个签名是一个256个字节的数字，它是GlobalSign Org用它的密钥对tbsCertificate做的签名，接下来用GlobalSign Org的公钥进行解密：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5c957322eefca311694187" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title">用公钥解密签名</span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon" style="background-size: 48px 128px; background-image: url(&quot;https://www.yinchengli.com/wp-content/plugins/crayon-syntax-highlighter/css/images/toolbar/buttons@2x.png&quot;);"></div></div><span class="crayon-language">Java</span></div></div>
			
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;">String decode = 

new BigInteger(signature, 16)   //先转成一个大数字
.pow(e)                         //再做e次幂
.mod(new BigInteger(N) )        //再模以N
.toString();

System.out.println(decode);</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5c957322eefca311694187-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c957322eefca311694187-2">2</div><div class="crayon-num" data-line="crayon-5c957322eefca311694187-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c957322eefca311694187-4">4</div><div class="crayon-num" data-line="crayon-5c957322eefca311694187-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c957322eefca311694187-6">6</div><div class="crayon-num" data-line="crayon-5c957322eefca311694187-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5c957322eefca311694187-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5c957322eefca311694187-1"><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">decode</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-5c957322eefca311694187-2">&nbsp;</div><div class="crayon-line" id="crayon-5c957322eefca311694187-3"><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">BigInteger</span><span class="crayon-sy">(</span><span class="crayon-v">signature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">16</span><span class="crayon-sy">)</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">//先转成一个大数字</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c957322eefca311694187-4"><span class="crayon-sy">.</span><span class="crayon-e">pow</span><span class="crayon-sy">(</span><span class="crayon-v">e</span><span class="crayon-sy">)</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">//再做e次幂</span></div><div class="crayon-line" id="crayon-5c957322eefca311694187-5"><span class="crayon-sy">.</span><span class="crayon-e">mod</span><span class="crayon-sy">(</span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">BigInteger</span><span class="crayon-sy">(</span><span class="crayon-v">N</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">//再模以N</span></div><div class="crayon-line crayon-striped-line" id="crayon-5c957322eefca311694187-6"><span class="crayon-sy">.</span><span class="crayon-e">toString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5c957322eefca311694187-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5c957322eefca311694187-8"><span class="crayon-v">System</span><span class="crayon-sy">.</span><span class="crayon-v">out</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">decode</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>注意在实际的计算中，不能直接e次幂，不然将是一个天文数字里的天文数字，计算量将会非常大，需要乘一次就模一次，很快就算出来了。计算出来的结果为：</p>
<p><img class="wp-image-883 aligncenter" src="assets/1553298343-03cfc8c9c8396c3cb88ef4831f066647.png" alt="" width="626" height="103"></p>
<p>这个结果又可以拆成几部分来看：</p>
<p><img class="wp-image-884 aligncenter" src="assets/1553298343-ad1e7d0c796a81e79fd425dae773197f.jpg" alt="" width="537" height="349"></p>
<p>第一个字节是00，第一个字节要比其它字节都要小，第二个字节是01，表示这是一个私有密钥操作，中间的ff是用来填充，加大签名的长度，加大破解难度，最后面的64个字节就是SHA哈希的值，如果证书没有被篡改过，那么将tbsCertificate作一个SHA哈希，它的值应该是和签名里面是完全一样的。所以接下来我们手动计算一下tbsCertificate的哈希值和签名里面的哈希进行对比。</p>
<p>这个的计算方式如下：</p>
<p style="text-align: center;">hash = SHA_256(DER(tbsCertificate))</p>
<p>注意不是将tbsCertificate直接哈希，是对它的DER编码值进行哈希，DER是一种加密方式。DER值可以在WireShark里面导出来，证书发过来的时候就已经被DER过了：</p>
<p><img class="wp-image-885 aligncenter" src="assets/1553298343-026e7ac48a6f912f892e0352c3b82faa.png" alt="" width="563" height="214"></p>
<p>然后再用openssl计算它的哈希值，命令为：</p>
<blockquote>
<p style="text-align: center;">openssl dgst -sha256 ~/tbsCertificate.bin</p>
</blockquote>
<p>计算结果为：</p>
<p><img class="wp-image-929 aligncenter" src="assets/1553298343-cdba4e47d405d2a3155f46e3a686fb2e.png" alt="" width="666" height="49"></p>
<p>即为：</p>
<blockquote>
<p class="p1"><span class="s1">bedfc063c41b62e0438bc8c0fff669de1926b5accfb487bf3fa98b8ff216d650</span></p>
</blockquote>
<p>和上面签名里面的哈希值进行对比，即下面的绿色字：</p>
<p><img class="wp-image-888 aligncenter" src="assets/1553298343-d04b848ce3bdc64145a66228be614c81.jpg" alt="" width="520" height="101"></p>
<p>可以发现：检验正确！这个证书没有被篡改过，确实是tmall的证书。那么这个时候问题来了，中间人有没有可能既篡改了证书，还能保证哈希值是对的？首先不同的字符串被SHA256哈希后的值是一样的概率比较小，同时由于密钥和公钥是一一配对的，所以中间人只能把公钥改成它的公钥，这个公钥是一个p * q的整数，所以他必须得满足两个条件，一个是要更改成一个有意义的公钥，另一个是整个证书的内容被哈希后的值和没改前是一样的，满足这两个条件就相当困难了。</p>
<p>所以我们有理由相信，只有知道了GlobalSign Org密钥的人，才能对这个证书正确地加密。也就是说，tmall的证书确实是GobalSign颁发和签名的，我们可以用相同的方式验证GlobalSign Org是GlobalSign Root颁发和签名。但是我们为什么要相信Gloabal Sign呢？</p>
<p>如果上面提到的中间人不篡改证书，而是把整一个证书都换它自己的证书，假设叫HackSign，证书里面要带上访问的域名，所以HackSign里面也会带上*.taobao.com。这个HackSign和GlobalSign有什么区别呢？为什么我们要相信GlobalSign，而不相信HackSign呢？</p>
<p>因为GlobalSign Root是浏览器或者操作系统自带的证书，在火狐浏览器的证书列表里面可以看到：</p>
<p><img class="wp-image-930 aligncenter" src="assets/1553298343-596cdcd2f8099c76e4e039e385f11a0e.png" alt="" width="449" height="54"></p>
<p>GlobalSign Root是Builtin的，即内置的。我们绝对相信GlobalSign Root，同时验证了GlobalSign Org是签名是合法的，GlobalSign Org给tmall的证书也是合法的。所以这个就是我们的信任链，从GlobalSign Root一直相信到了tmall。而*.taobao.com的域名已经被证书机构注册了，所以另外的人是不能再用*.taobao.com去注册它的证书的。</p>
<p>所以证书为什么会有有效期，证书为什么要购买，从这里就可以知道原因了。</p>
<p>到这里，你可能又会冒出来另外一个问题，既然我不能改证书，也不能换证书，那我难道不能直接克隆你的证书放到我的机器上去，因为证书是完全公开透明的，可以在浏览器或者wireshark里面看到证书的完整内容。然后我再用域名污染等技术将你访问的域名打到我的机器上，那么我跟你一模一样的证书不也是合法的？证书不就没用了？</p>
<p>这个问题之前也困扰我许久，为了回答这个问题，我们先继续讲解连接的过程。</p>
<p>上面已经说到浏览器已经验证了证书是合法的，接下来：</p>
<h3>6. 密钥交换Key Exchange</h3>
<p>上文提到服务器选择的加密组合方式为：</p>
<p style="text-align: center;">Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)</p>
<p>这一串加密方式可以分成三部分：</p>
<p><img class=" wp-image-893 aligncenter" src="assets/1553298343-4bf3ac994d49e75e36718e54ed227384.png" alt="" width="366" height="142"></p>
<p>服务器选中的密钥交换加密方式为RSA，数据传输加密方式为AES，检验数据是否合法的算法为SHA256.</p>
<p>具体的密钥交换为ECDHE_RSA，什么叫ECDHE呢？</p>
<p>由于证书的密钥和公钥（2048位）都比较大，使用ECDH 算法最大的优势在于，在安全性强度相同的情况下，其所需的密钥长度较短。以 DH 演算法密钥长度 2048 位元为例。ECDH 算法的密钥长度仅需要 224 位元即可</p>
<p>所以RSA是用来验证身份然后交换密钥的，并不是用来加密数据的，因为它太长了，计算量太大。加密数据是用的ECDHE生成的密钥和公钥。</p>
<p>在服务器发送了它的证书给浏览器之后，就进行了密钥交换Server Key Exchange和Client Key Exchange：</p>
<p><img class="wp-image-894 aligncenter" src="assets/1553298343-e96b627df96cdf52cfc3ca6cc7b6c98f.jpg" alt="" width="680" height="59"></p>
<p>在WireShark里面展开，可以看到它发给客户端的公钥：</p>
<p><img class="wp-image-931 aligncenter" src="assets/1553298343-645f65912f61ebd2f8a9f0f2f9c5bf6b.png" alt="" width="524" height="122"></p>
<p>这个公钥只有65个字节，260位，和上面的270个字节的公钥相比，已经短了很多。</p>
<p>同样地，浏览器结合服务器发给它的随机密码(Server Hello)，生成它自己的主密钥，然后发送公钥发给服务器：</p>
<p><img class="wp-image-932 aligncenter" src="assets/1553298343-8e5efe5a9bf4dcdebbb1ee83b0a15e81.png" alt="" width="549" height="174"></p>
<p>这个公钥也是只有65个字节</p>
<p>双方交换密钥之后，浏览器给服务器发了一个明文的Change Cipher Spec的包，告诉服务器我已经准备好了，可以开始传输数据了：</p>
<p><img class="wp-image-896 aligncenter" src="assets/1553298343-bbd285f1eda6de5bb73a06a47e68e219.jpg" alt="" width="700" height="29"></p>
<p>同样地，服务器也会给浏览器发一个Change Cipher Spec的包：</p>
<p><img class="wp-image-897 aligncenter" src="assets/1553298343-27a933a1fcc41c8f3f9363f20edaa3a4.jpg" alt="" width="823" height="23"></p>
<p>浏览器给服务回了个ACK，然后就开始传输数据：</p>
<p><img class="wp-image-898 aligncenter" src="assets/1553298343-ef1e542bdccf04a680cd480c1d6f2874.jpg" alt="" width="689" height="115"></p>
<p>传输数据是用的http传输的，但是数据是加密的，没有密钥是没办法解密的：</p>
<p><img class="wp-image-899 aligncenter" src="assets/1553298343-7240fd9fa76cd61ff1a3ec5bf682f853.png" alt="" width="664" height="76"></p>
<p>上面已经提到服务器选择的数据传输加密方式为AES，AES是一种高效的加密方式，它会使用主密钥生成另外一把密钥，其加密过程可见维基百科。</p>
<p>到此，整一个连接过程就讲解完了。这个时候就可以回答上文提出的证书被克隆的问题，其实答案很简单，因为这是没有意义的。双方采用RSA交换公钥，使用的公钥和密钥是一一配套的，所以只要证书是对的，即公钥是对的，对方没办法知道配套的密钥是多少，所以即使证书被克隆，对方收到的数据是无法解密的。所以没有人会取偷证书，因为是没有意义的，因为他不知道密钥，从这个角度来说证书可以验证身份的合法性是可以理解的</p>
<p>这个连接的过程大概多久呢？</p>
<h2>四、使用https的代价</h2>
<p>在wireshark里面可以看到每个包的发送时间：</p>
<p><img class="wp-image-900 aligncenter" src="assets/1553298343-9e73b3fef0745c63dfe9c88620c8ebff.png" alt="" width="634" height="241"></p>
<p>从最开始的Client Hello，到最后的Change Cipher Spec的包，即从4.99s到5.299秒，这个建立https连接的过程为0.3s。所以使用https是需要付出代价：</p>
<ol>
<li>建立https需要花费时间(~0.3s)</li>
<li>数据需要加密和解密，占用更多的cpu</li>
<li>数据加密后比原信息更大，占用更多的带宽</li>
</ol>
<h2>五、怎样绕过https</h2>
<p>使用ssltrip，这个工具它的实现原理是先使用arp欺骗和用户建立连接，然后强制将用户访问的https替换成http。即中间人和用户之间是http，而和服务器还是用的https。<br>
怎样规避这个问题：<br>
如果经常访问的网站是https的，某一天突然变成了http，那么很可能有问题，最直观的就是浏览器地址栏的小锁没有了：</p>
<p><img class="wp-image-902 aligncenter" src="assets/1553298343-5ab7354af7b5061dd7c826ee4b88a999.png" alt="" width="370" height="23"></p>
<h2>六、怎样创建一个自签名的证书</h2>
<p>证书要么买，要么自己创建一个，可以使用openssl生成一个证书：</p>
<p class="p1" style="text-align: center;"><span class="s1">openssl req -x509 -nodes -sha256 -days 365 -newkey rsa:2048 -keyout test.com.key -out test.com.crt</span></p>
<p>如上，使用sha256 + rsa 2048位，有效期为365天，输出为证书test.com.crt和密钥test.com.key，在生成过程中它会让你填相关的信息：</p>
<p><img class="wp-image-903 aligncenter" src="assets/1553298343-dde8ac675b2342f22a1d4d0ef6b9048d.png" alt="" width="534" height="349"></p>
<p>最后会生成两个文件，一个是证书（未被签名），另一个是密钥：</p>
<p><img class="wp-image-904 aligncenter" src="assets/1553298343-4850e83ab3cfe8d94fd6db909ee6defc.png" alt="" width="214" height="107"></p>
<p>然后把这个证书添加到浏览器里面，设置为信任，浏览器就不会报NET::ERR_CERT_AUTHORITY_INVALID的错误，就可以正常使用这个证书了。</p>
<p>本文的思路是参考了另外一篇博客：<a href="http://blog.jobbole.com/48369/">https连接的前几毫秒发生了什么</a>，这篇博客写于2009年，里面有些东西稍微比较老了，还有就是有些关键点说得不够透彻。经过笔者一番研究才有了上面的讲解。</p>
<p>&nbsp;</p>
<div class="post-views post-288 entry-meta">
				<span class="post-views-icon dashicons  dashicons-chart-bar"></span>
				<span class="post-views-label">Post Views: </span>
				<span class="post-views-count">3,745</span>
			</div>			</div><!-- .entry-content -->

	<footer class="entry-footer">
			</footer><!-- .entry-footer -->
</article></MAIN></DIV></DIV></DIV></DIV>
      
        <hr />
        <!-- clipping information -->
        <div class="clipping-information">
          <label>原网址: <a href="https://www.yinchengli.com/2016/11/13/https/" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">访问</a></label><br />
          <label>创建于: 2019-03-23 07:45:43</label><br />
          <label>目录: default</label><br />
          <label>标签: 无</label>
        </div>
    </div>
  </body>
</html>